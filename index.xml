<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Palfans's BLOG</title><link>https://www.palfans.net/</link><description>Recent content on Palfans's BLOG</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 25 Jan 2024 03:04:41 +0000</lastBuildDate><atom:link href="https://www.palfans.net/index.xml" rel="self" type="application/rss+xml"/><item><title>Mobaxterm 通过 Session Manager 访问 AWS EC2 实例</title><link>https://www.palfans.net/mobaxterm-access-ec2-via-session-manager/</link><pubDate>Thu, 25 Jan 2024 03:04:41 +0000</pubDate><guid>https://www.palfans.net/mobaxterm-access-ec2-via-session-manager/</guid><description>&lt;h2 id="需求">需求&lt;/h2>
&lt;p>在 AWS 上部署了一个项目，包含四个 EC2 实例。其中一个为堡垒机实例，另外三个为业务实例。在子网的安全组中，关闭了 22 端口，只能通过 AWS 网页上的 Session Manager 访问堡垒机，再跳到其它业务机上。但 AWS 网页版的终端使用起来有很多限制，比如不能“选择即复制”，不能“右键快速粘贴”，会话无法保活等。
因此，希望可以使用桌面终端，比如 Mobaxterm，通过 Session Manager 来访问 EC2 实例。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>通过 &lt;code>AWS Command Line Interface(AWS CLI)&lt;/code> 连接 Session Manager，经由 &lt;code>System Manager Agent(SSM Agent)&lt;/code> 将所有操作转发给 EC2。&lt;/p>
&lt;h3 id="使用-session-manager-的前提">使用 Session Manager 的前提&lt;/h3>
&lt;ul>
&lt;li>EC2 实例安装了 &lt;code>SSM Agent&lt;/code>&lt;/li>
&lt;li>EC2 实例绑定了 IAM Role &lt;code>AmazonSSMManagedInstanceCore&lt;/code>&lt;/li>
&lt;li>EC2 可以直接或者通过 Session Manager 的 VPC Endpoint 连接 Session Mananger 服务
具体参照 AWS &lt;a href="https://docs.aws.amazon.com/zh_cn/systems-manager/latest/userguide/systems-manager-setting-up.html">官方文档&lt;/a>进行设置。&lt;/li>
&lt;/ul>
&lt;h3 id="安装配置-aws-cli">安装配置 AWS CLI&lt;/h3>
&lt;p>首先参照 AWS &lt;a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/getting-started-install.html">官方文档&lt;/a> 安装或者更新 AWS CLI 的最新版本。&lt;/p>
&lt;p>要通过 AWS CLI 启动 Session Manager 会话，还必须安装 Session Manager 插件，参照 AWS &lt;a href="https://docs.aws.amazon.com/zh_cn/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">官方文档&lt;/a>&lt;/p>
&lt;p>在 &lt;a href="https://us-east-1.console.aws.amazon.com/iam/home#/security_credentials?section=IAM_credentials">IAM&lt;/a> 中创建 Access Key，记下 Key ID 和 Secret。&lt;/p>
&lt;p>在本地终端中执行 &lt;code>aws configure&lt;/code>，填入刚刚创建的 Access Key，Secret，和 EC2 实例所在的区域，比如&lt;code>us-east-1&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">palfans@lab:~/.aws$ aws configure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">AWS Access Key ID []:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">AWS Secret Access Key []:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Default region name []:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Default output format [None]:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在本地终端中执行&lt;code>aws ec2 describe-instances | grep InstanceId&lt;/code>，获取到 EC2 实例ID，然后用&lt;code>aws ssm start-session --target &amp;lt;InstanceId&amp;gt;&lt;/code>连接到 EC2。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">palfans@lab:~/.aws$ aws ec2 describe-instances | grep InstanceId
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;InstanceId&amp;#34;: &amp;#34;i-09721fab06a6d0000&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">palfans@lab:~/.aws$
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">palfans@lab:~/.aws$ aws ssm start-session --target i-09721fab06a6d0000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Starting session with SessionId: palfans-094975208f6800000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sh-5.2$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="配置-mobaxterm">配置 Mobaxterm&lt;/h3>
&lt;p>现在已经可以通过 AWS CLI 访问 EC2，还需要支持 SSH，以便拥有更多功能的 Mobaxterm 等终端软件可以连接。&lt;/p>
&lt;p>首先在堡垒机的&lt;code>~/.ssh/authorized_keys&lt;/code>中添加公钥，之后就可以用私钥进行校验。&lt;/p>
&lt;p>然后在 Mobaxterm 中新建一个 SSH 连接，Remote host 为 EC2 的 &lt;code>InstanceId&lt;/code>，比如 i-09721fab06a6d0000。用户名为 &lt;code>ec2-user&lt;/code>。&lt;/p>
&lt;p>在&lt;code>Advanced SSH settings&lt;/code>-&amp;gt;&lt;code>Use private key&lt;/code>中，选择对应的私钥文件。&lt;/p>
&lt;p>在&lt;code>Network settings&lt;/code>-&amp;gt;&lt;code>Proxy settings&lt;/code>中，Proxy type为&lt;code>Local&lt;/code>，Local proxy command为&lt;code>aws ssm start-session --target %host --document-name AWS-StartSSHSession --parameters 'portNumber=%port'&lt;/code>。&lt;/p>
&lt;p>如果 AWS CLI 是安装在 Windows 附带的 WSL2 中，则 Local proxy command为&lt;code>wsl aws ssm start-session --target %host --document-name AWS-StartSSHSession --parameters 'portNumber=%port'&lt;/code>。&lt;/p>
&lt;p>保存后即可在 Mobaxterm 中连接 EC2。&lt;/p></description></item><item><title>IPTV PHP 爬虫片段</title><link>https://www.palfans.net/iptv-php-scraping-snippet/</link><pubDate>Mon, 16 Oct 2023 15:39:48 +0000</pubDate><guid>https://www.palfans.net/iptv-php-scraping-snippet/</guid><description>&lt;p>现在有很多线上 IPTV 服务，限制只能在浏览器的播放器观看，可以通过 PHP 爬取对应的流媒体源，来实现在其他应用或电视上观看。&lt;/p>
&lt;h2 id="iptv-源分类">IPTV 源分类&lt;/h2>
&lt;h3 id="不限制-referer">不限制 Referer&lt;/h3>
&lt;p>这类源最简单，直接 PHP 发送请求获取到流媒体的链接。&lt;/p>
&lt;p>&lt;code>iptv-sample-a.php&lt;/code> 代码片段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="nx">php&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_init&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_RETURNTRANSFER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYPEER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYHOST&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_FOLLOWLOCATION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">TRUE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_exec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="严格限制-referer">严格限制 Referer&lt;/h3>
&lt;p>这类源的服务器会检查所有访问请求的 HTTP Header，如果 Referer 不匹配当前提供服务的网站域名，就拒绝返回正确的流媒体数据。现在大部分的源服务器都会检查 Header。&lt;/p>
&lt;p>一般的解决方法是用浏览器正常打开源服务器的页面，通过 Chrome/Edge 的开发者工具获取到正确的 HTTP Header，再使用 PHP 发送相同的 Header 来模拟浏览器访问。&lt;/p>
&lt;p>&lt;code>iptv-sample-b.php&lt;/code> 代码片段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="nx">php&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$id&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$baseurl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;https://iptv.stream/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Referer: https://iptv.stream/&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 获取 ts
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// 流媒体的链接为 https://iptv.stream/100/index.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$baseurl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;/index.php&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$reg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/(.*?.ts)/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">preg_match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$reg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 如果 ts 为相对路径，则在前面加上 $baseurl 后返回；如果为绝对路径，直接返回。
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 构建m3u8内容
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$m3u8_content&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;#EXTM3U&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$m3u8_content&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="s2">&amp;#34;#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=2000000&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$m3u8_content&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">$ts\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 输出m3u8内容
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$m3u8_content&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_init&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_RETURNTRANSFER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYPEER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYHOST&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_FOLLOWLOCATION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">TRUE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_HTTPHEADER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_exec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ts-文件也被检查">ts 文件也被检查&lt;/h3>
&lt;p>如果源服务器连 ts 文件的请求也要检查 Header，需要将 m3u8 内的 ts 链接修改为 php 所在的服务器，并在收到 ts 请求后，附加正确的 header，发往源服务器，最后将获取到的二进制数据返回给客户端。缺点是 php 所在的服务器需要消耗所有的上下行流媒体流量。&lt;/p>
&lt;p>&lt;code>iptv-sample-c.php&lt;/code> 代码片段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="nx">php&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;ts&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;ts&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$id&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$baseurl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;https://iptv.stream/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Referer: https://iptv.stream/&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 获取 m3u8
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// 流媒体的链接为 https://iptv.stream/100/index.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$baseurl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;/index.php&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$e_url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$reg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/(.*?.m3u8)/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">preg_match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$reg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 获取 ts
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$baseurl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">dirname&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$e_url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$str&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$baseurl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;/&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nv">$str&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$e_url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$reg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/(.*\.ts)/i&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">preg_match_all&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$reg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">foreach&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nv">$key&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">str_replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;iptv-sample-c.php?ts=&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nx">strtr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">base64_encode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">$baseurl&lt;/span>&lt;span class="s2">/&lt;/span>&lt;span class="si">$value&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;+/&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;-_&amp;#39;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nv">$res&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">echo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$res&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ts&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Referer: https://iptv.stream/&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$decoded_ts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">base64_decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strtr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ts&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;-_&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;+/&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$decoded_ts&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nv">$e_url&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_init&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_RETURNTRANSFER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYPEER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYHOST&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_FOLLOWLOCATION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">TRUE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_HTTPHEADER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_exec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$e_url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_getinfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLINFO_EFFECTIVE_URL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">ts&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_init&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYPEER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYHOST&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_FOLLOWLOCATION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">TRUE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_HTTPHEADER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_exec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="源服务器使用-flv">源服务器使用 flv&lt;/h3>
&lt;p>如果源服务器返回的是 flv 文件，可以直接将请求重定向到这个链接。&lt;/p>
&lt;p>&lt;code>iptv-sample-d.php&lt;/code> 代码片段&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;?&lt;/span>&lt;span class="nx">php&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$id&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="s1">&amp;#39;-1&amp;#39;&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$baseurl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;https://iptv.stream/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$header&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;Referer: https://iptv.stream/&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 获取 m3u8
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// 流媒体的链接为 https://iptv.stream/100/index.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$baseurl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;/index.php&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$e_url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$reg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/(.*?.flv)/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">preg_match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$reg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$flv&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$arr&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 重定向链接到 flv 文件
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">header&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;location:&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nv">$flv&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nv">$e_url&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$ch&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_init&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_URL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$url&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_RETURNTRANSFER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYPEER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_SSL_VERIFYHOST&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_FOLLOWLOCATION&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">TRUE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_setopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLOPT_HTTPHEADER&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$header&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_exec&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$e_url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">curl_getinfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CURLINFO_EFFECTIVE_URL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curl_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$ch&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>通过 SSH 访问 GitHub</title><link>https://www.palfans.net/access-github-via-ssh/</link><pubDate>Sat, 30 Apr 2022 14:43:29 -0500</pubDate><guid>https://www.palfans.net/access-github-via-ssh/</guid><description>&lt;h2 id="需求">需求&lt;/h2>
&lt;p>公司有自建的 GitHub 企业版，必须通过 VPN 或者 SSH 跳板机才能访问网页，如何在客户端通过命令行存取远端代码库呢？&lt;/p>
&lt;h3 id="示例">示例&lt;/h3>
&lt;p>GitHub 企业版地址：&lt;code>github.abc.com&lt;/code>
跳板机：&lt;code>jump_host&lt;/code>
跳板机用户名：&lt;code>jump&lt;/code>&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>公司的 GitHub 启用了大文件存储模式 &lt;code>Git-LFS&lt;/code>， checkout 代码库的时候，客户端需要先通过 SSH 取回库的内容（包括大文件的占位符），再通过 HTTPS 取回对应占位符的大文件。因此在配置跳板机时，需要同时考虑 SSH 和 HTTPS 两种协议的代理转发。&lt;/p>
&lt;h3 id="ssh-转发">SSH 转发&lt;/h3>
&lt;p>SSH 转发配置非常直接，通过跳板机转发所有发送到目标地址的 SSH 流量。&lt;/p>
&lt;p>&lt;em>编辑 &lt;code>~/.ssh/config&lt;/code>&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Host github.abc.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Hostname github.abc.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> User git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ProxyCommand ssh jump@jump_host -W %h:%p
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里的 &lt;code>ProxyCommand&lt;/code> 会利用 &lt;code>ssh -W&lt;/code> 来连接跳板机然后转发请求。&lt;code>-W&lt;/code> 参数在较新的 OpenSSH 中获得支持，至少需要 &lt;code>5.4&lt;/code> &lt;a href="http://www.openssh.com/txt/release-5.4">link&lt;/a>。在较老的版本中，则可以使用 &lt;code>nc (netcat)&lt;/code> 代替。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ProxyCommand ssh jump@jum_host nc -q0 %h %p
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在配置文件中不能存储 SSH 账号的密码，如果已经配置了服务器和跳板机的公钥访问，则可以直接免密码连接，否则会在连接过程中要求输入密码。&lt;/p>
&lt;h3 id="httphttps-转发">HTTP/HTTPS 转发&lt;/h3>
&lt;p>建立了 SSH 隧道，我们还需要一个 HTTP/HTTPS 代理才能访问 GitHub LFS。通常情况下，我们不能在跳板机新安装一个代理软件，这里我们就在客户端本地安装一个基于 SSH 的 HTTP/HTTPS 代理 &lt;code>mallory&lt;/code> &lt;a href="https://github.com/justmao945/mallory">link&lt;/a>。这个代理对于跳板机的唯一要求就是 SSH 可用，不用任何其他配置。&lt;/p>
&lt;p>这是一个使用 GoLang 编写的开源代理软件，直接用下面的命令即可安装完成，装好的程序位于 &lt;code>~/go/bin/mallory&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">go install github.com/justmao945/mallory/cmd/mallory@latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>编辑 &lt;code>~/.config/mallory.json&lt;/code>&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id_rsa&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;$HOME/.ssh/id_rsa&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;local_smart&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;:1315&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;local_normal&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;:1316&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;remote&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ssh://jump@jump_host&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;blocked&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;github.abc.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>代理会启动两个端口，&lt;code>local_normal&lt;/code> 会转发所有 HTTP/HTTPS 请求到跳板机，&lt;code>local_smart&lt;/code> 只会转发目标地址为 blocked 中配置域名的请求到跳板机。&lt;/p>
&lt;p>&lt;em>启动代理软件&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">nohup ~/go/bin/mallory &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>编辑 &lt;code>~/.gitconfig&lt;/code>&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[http &amp;#34;https://github.abc.com&amp;#34;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy = http://localhost:1315
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sslVerify = false
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>现在所有的 Git 操作（SSH，HTTP/HTTPS）都会通过跳板机访问到 GitHub 服务器。&lt;/p></description></item><item><title>利用 GitHub Actions 自动编译发布基于 Hugo 的网站</title><link>https://www.palfans.net/deploy-hugo-with-github-action/</link><pubDate>Thu, 21 Apr 2022 16:12:21 -0500</pubDate><guid>https://www.palfans.net/deploy-hugo-with-github-action/</guid><description>&lt;h2 id="需求">需求&lt;/h2>
&lt;p>自从把网站从 Wordpress 转成 Hugo 并托管在 GitHub 之后，一直使用 Travis CI 来自动编译部署更新。
距离上次更新又过了一年多，昨天想发个牢骚，感叹下时事多艰，结果发现 Travis CI 已经删除我之前的代码库配置。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>在 Hugo 的官方文档网站看到推荐用 &lt;code>GitHub Actions&lt;/code> 来完成类似的工作 &lt;a href="https://gohugo.io/hosting-and-deployment/hosting-on-github/#build-hugo-with-github-action">link&lt;/a>。看起来不麻烦，开干。&lt;/p>
&lt;h3 id="规划代码库">规划代码库&lt;/h3>
&lt;p>GitHub 的每一个账号都可以创建单独的 Pages 站点，但是该代码库必须将可见性设为 Public。如果不希望公开自己网站源文件，就需要合理规划代码库。&lt;/p>
&lt;p>创建两个代码库&lt;/p>
&lt;ul>
&lt;li>&lt;code>&amp;lt;anyname&amp;gt;.github.io&lt;/code> &amp;ndash; 这个库用来展示静态页面，&lt;code>anyname&lt;/code> 需要是 GitHub 全站唯一名字，必须以 github.io 结尾并设置为 Public 可见，下文以 &lt;code>web&lt;/code> 代替。&lt;/li>
&lt;li>&lt;code>any project name&lt;/code> &amp;ndash; 这个库的名字随意，下文以 &lt;code>web-code&lt;/code> 代替，可以设置为 Private 可见。&lt;/li>
&lt;/ul>
&lt;h3 id="创建-workflow">创建 Workflow&lt;/h3>
&lt;p>在 &lt;code>web-code&lt;/code> 代码库的默认 &lt;code>main&lt;/code> 分支下，创建 Workflow 的配置文件 &lt;code>.github/workflows/gh-pages.yml&lt;/code>，配置内容由 Hugo 官方提供，添加了部分注释：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">GitHub Pages&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">push&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">main&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 网站更新 push 到 web-code 库的 main 分支之后，触发这个 Action&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pull_request&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runs-on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu-20.04&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">concurrency&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ github.workflow }}-${{ github.ref }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">actions/checkout@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">submodules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Fetch Hugo themes (true OR recursive)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fetch-depth&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Fetch all history for .GitInfo and .Lastmod&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Setup Hugo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-hugo@v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hugo-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;latest&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 默认为最新版本，有特殊需要，可以指定其他 Hugo 版本&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extended&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 激活 Hugo Extended 特性，部分主题需要打开 Hugo 的这个选项&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hugo --minify&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-gh-pages@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">if&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ github.ref == &amp;#39;refs/heads/main&amp;#39; }}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 只在 main 分支下被触发&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c">#github_token: ${{ secrets.GITHUB_TOKEN }} # 如果只创建一个代码库，把 web-code 和 web 分别放置在不同分支，则可以直接使用免配置的 GITHUB_TOKEN&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">deploy_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ secrets.DEPLOY_TOKEN }}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 如果创建两个代码库，则需要采用 DEPLOY_TOKEN 或者 PERSIONAL_TOKEN 进行身份认证&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">external_repository&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;your account&amp;gt;/&amp;lt;webname&amp;gt;.github.io&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># web 代码库&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./public&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">keep_files&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_branch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">main&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># web 代码库的默认分支&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cname&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">www.abc.com&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 开启自定义域名，在 web 代码库根目录生成 CNAME 文件，需要和 &amp;lt;web 代码库&amp;gt;/settings/pages 里设置的自定义域名匹配&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="设置-deploy_token">设置 DEPLOY_TOKEN&lt;/h3>
&lt;p>在终端（Linux/MacOS: terminal; Windows: CMD）生成公私钥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">ssh-keygen -t rsa -b &lt;span class="m">4096&lt;/span> -C &lt;span class="s2">&amp;#34;&amp;lt;your github email&amp;gt;&amp;#34;&lt;/span> -f gh-pages
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>命令执行后生成私钥 &lt;code>gh-pages&lt;/code>，和公钥 &lt;code>gh-pages.pub&lt;/code>。
访问 &lt;code>&amp;lt;web 代码库&amp;gt;/settings/keys/new&lt;/code>，将 &lt;code>gh-pages.pub&lt;/code> 内容复制到 &lt;code>Key&lt;/code> 中，&lt;code>Title&lt;/code> 随意，需要勾选 &lt;code>Allow write access&lt;/code>。
访问 &lt;code>&amp;lt;web-code 代码库&amp;gt;/settings/secrets/actions/new&lt;/code>, 将 &lt;code>gh-pages&lt;/code> 内容复制到 &lt;code>Value&lt;/code> 中，&lt;code>Name&lt;/code> 为 &lt;code>DEPLOY_TOKEN&lt;/code>。&lt;/p>
&lt;h3 id="提交代码">提交代码&lt;/h3>
&lt;p>将更新的日志提交到 &lt;code>web-code&lt;/code> 代码库的 &lt;code>main&lt;/code> 分支，推送到 GitHub，就会自动触发编译发布。新版本的 Action 脚本不再使用 docker 构建编译环境，一般只需要 20 秒钟就能在自定义的域名看到新增的日志。&lt;/p></description></item><item><title>通过 VPN 远程办公</title><link>https://www.palfans.net/work_from_home_via_vpn/</link><pubDate>Fri, 19 Mar 2021 10:42:24 -0500</pubDate><guid>https://www.palfans.net/work_from_home_via_vpn/</guid><description>&lt;h2 id="需求">需求&lt;/h2>
&lt;p>作为一名实施人员，通常情况下需要通过各种 VPN 连接到公司和客户的工作环境来完成任务。尤其是疫情的影响，完全在家工作，对 VPN 的利用就更重了。&lt;/p>
&lt;p>但是，VPN 装多了，各种虚拟网卡驱动相互之间不一定能好好兼容，即使是 Windows 10 也很容易蓝屏，要是不幸发生在工作过程中，尤其是更新生产系统，那就有得事情做了。&lt;/p>
&lt;h2 id="解决方案">解决方案&lt;/h2>
&lt;p>我能想到的解决方案，还是虚拟机。把所有的 VPN 都装在虚拟机里边，即使不幸虚拟机挂了，也可以在几分钟内恢复一份快照，而且这个异常完全不会影响到宿主机的系统。&lt;/p>
&lt;p>在 Windows 上，常用的虚拟机解决方案有&lt;/p>
&lt;ul>
&lt;li>商用的 VMWare&lt;/li>
&lt;li>免费的 Virtualbox&lt;/li>
&lt;li>Windows 10 自带的 Hyper-V&lt;/li>
&lt;/ul>
&lt;p>在 Windows 10 ver20H2 之前，Hyper-V 和其他两个解决方案是互斥的，如果启用了 Hyper-V，那么 VMWare 和 Virtualbox 都不能正常启动。更新到 20H2 之后，它们就可以共存了。&lt;/p>
&lt;h2 id="虚拟机设置">虚拟机设置&lt;/h2>
&lt;p>为了充分利用宿主机已经安装的程序和各类文件，这套虚拟机只是用来连接到工作网络，宿主机以其为跳板完成工作任务。所以虚拟机选择 Linux 作为操作系统，内存分配 1GB 完全足够。&lt;/p>
&lt;p>网络设置方面，虚拟机需要能访问互联网，同时也被宿主机访问，所以网卡类型选择 &lt;code>bridge&lt;/code> 或者 &lt;code>nat + host-only&lt;/code>，通过 &lt;code>ip a&lt;/code> 命令查看虚拟机的网络地址，测试宿主机能否 ping 通这个地址。&lt;/p>
&lt;p>接下来就是安装 VPN 的客户端和相关配置，这里以 CentOS 7 为例。&lt;/p>
&lt;h3 id="openvpn">OpenVPN&lt;/h3>
&lt;h4 id="安装">安装&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 epel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install -y epel-release
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 openvpn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install -y openvpn
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置">配置&lt;/h4>
&lt;p>创建一个 Shell Script 脚本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># start OpenVPN client daemon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo openvpn --daemon --cd &amp;lt;work-folder&amp;gt; --config &amp;lt;ovpn-file&amp;gt; --log-append /var/log/openvpn.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># add traffic forward firewall rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MASQUERADE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>sudo firewall-cmd --zone&lt;span class="o">=&lt;/span>public --query-masquerade&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="s2">&amp;#34;x&lt;/span>&lt;span class="nv">$MASQUERADE&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xyes&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo firewall-cmd --zone&lt;span class="o">=&lt;/span>public --add-masquerade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="运行">运行&lt;/h4>
&lt;p>直接运行这个脚本&lt;/p>
&lt;h3 id="cisco-vpn-client">Cisco VPN Client&lt;/h3>
&lt;h4 id="安装-1">安装&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 epel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install -y epel-release
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 vpnc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install -y vpnc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置-1">配置&lt;/h4>
&lt;p>创建一个 Shell Script 脚本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># start Cisco VPN Client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo vpnc &lt;span class="k">$(&lt;/span>dirname &lt;span class="k">$(&lt;/span>readlink -f &lt;span class="nv">$0&lt;/span>&lt;span class="k">))&lt;/span>/&amp;lt;cisco-legacy-vpn-config-file&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># add traffic forward firewall rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MASQUERADE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>sudo firewall-cmd --zone&lt;span class="o">=&lt;/span>public --query-masquerade&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="s2">&amp;#34;x&lt;/span>&lt;span class="nv">$MASQUERADE&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xyes&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo firewall-cmd --zone&lt;span class="o">=&lt;/span>public --add-masquerade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>参考下列例子，准备好 &lt;code>cisco-legacy-vpn-config-file&lt;/code>，文件名随意，放置在脚本的相同目录&lt;/p>
&lt;p>Cisco VPN Client Config Sample&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">IPSec gateway &amp;lt;VPN server IP&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">IPSec ID &amp;lt;Group ID&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">IPSec secret &amp;lt;Group Password&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Xauth username &amp;lt;Username&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Xauth password &amp;lt;Password&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Local Port 0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="运行-1">运行&lt;/h4>
&lt;p>直接运行这个脚本&lt;/p>
&lt;h3 id="cisco-anyconnect-secure-mobility-client">Cisco AnyConnect Secure Mobility Client&lt;/h3>
&lt;h4 id="安装-2">安装&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 epel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install -y epel-release
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 openconnect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo yum install -y openconnect
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置-2">配置&lt;/h4>
&lt;p>创建一个 Shell Script 脚本&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># add traffic forward firewall rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">MASQUERADE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>sudo firewall-cmd --zone&lt;span class="o">=&lt;/span>public --query-masquerade&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[[&lt;/span> &lt;span class="s2">&amp;#34;x&lt;/span>&lt;span class="nv">$MASQUERADE&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> !&lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;xyes&amp;#34;&lt;/span> &lt;span class="o">]]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo firewall-cmd --zone&lt;span class="o">=&lt;/span>public --add-masquerade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># start openconnect&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># automatically input password&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;password&amp;gt;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$PASSWORD&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">read&lt;/span> -p &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> X
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$X&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">)&lt;/span> &lt;span class="p">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo openconnect &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --user &amp;lt;username&amp;gt; &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --os&lt;span class="o">=&lt;/span>win &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --csd-wrapper&lt;span class="o">=&lt;/span>&amp;lt;bogus-csd-wrapper-script&amp;gt; &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &amp;lt;VPN server IP&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Cisco AnyConnect 对客户端的要求比较多，需要检查客户端是否符合服务器安全设置，有些服务端还配置了 2FA，所以不能做到脚本完全自动连接。首先参考下列例子，准备好 &lt;code>bogus-csd-wrapper-script&lt;/code>，文件名随意，放置在脚本的相同目录，以此提交一个符合服务端安全设置的连接请求。&lt;/p>
&lt;p>Cisco Anyconnect CSD wrapper Sample&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> ! xmlstarlet --version &amp;gt;/dev/null 2&amp;gt;&lt;span class="p">&amp;amp;&lt;/span>1&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;************************************************************************&amp;#34;&lt;/span> &amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;WARNING: xmlstarlet not found in path; CSD token extraction may not work&amp;#34;&lt;/span> &amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;************************************************************************&amp;#34;&lt;/span> &amp;gt;&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">unset&lt;/span> XMLSTARLET
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">XMLSTARLET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">DATA&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;endpoint.os.version=&amp;#34;Linux&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.os.servicepack=&amp;#34;4.17.9-200.fc28.x86_64&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.os.architecture=&amp;#34;x64&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.policy.location=&amp;#34;Default&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.protection=&amp;#34;none&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.protection_version=&amp;#34;3.1.03103&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.hostname=&amp;#34;&amp;lt;VPN server hostname/IP&amp;gt;&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;9217&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;139&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;53&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;22&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;631&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;445&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.port[&amp;#34;9216&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;9217&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;139&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;53&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;22&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;631&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;445&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp4port[&amp;#34;9216&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp6port[&amp;#34;139&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp6port[&amp;#34;53&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp6port[&amp;#34;22&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp6port[&amp;#34;631&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.tcp6port[&amp;#34;445&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.MAC[&amp;#34;FFFF.FFFF.FFFF&amp;#34;]=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.device.protection_extension=&amp;#34;3.6.4900.2&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.fw[&amp;#34;IPTablesFW&amp;#34;]={};
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.fw[&amp;#34;IPTablesFW&amp;#34;].exists=&amp;#34;true&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.fw[&amp;#34;IPTablesFW&amp;#34;].description=&amp;#34;IPTables (Linux)&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.fw[&amp;#34;IPTablesFW&amp;#34;].version=&amp;#34;1.6.1&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">endpoint.fw[&amp;#34;IPTablesFW&amp;#34;].enabled=&amp;#34;ok&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">shift&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">TICKET&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">STUB&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;-ticket&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">shift&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">TICKET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;-stub&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">shift&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">STUB&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">1&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="se">\&amp;#34;&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">shift&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PINNEDPUBKEY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-s &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">CSD_SHA256&lt;/span>&lt;span class="p">:+&lt;/span>&lt;span class="s2">&amp;#34;-k --pinnedpubkey sha256//&lt;/span>&lt;span class="nv">$CSD_SHA256&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://&lt;/span>&lt;span class="nv">$CSD_HOSTNAME&lt;/span>&lt;span class="s2">/+CSCOE+/sdesktop/token.xml?ticket=&lt;/span>&lt;span class="nv">$TICKET&lt;/span>&lt;span class="s2">&amp;amp;stub=&lt;/span>&lt;span class="nv">$STUB&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$XMLSTARLET&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">TOKEN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl &lt;span class="nv">$PINNEDPUBKEY&lt;/span> -s &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$URL&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> xmlstarlet sel -t -v /hostscan/token&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">TOKEN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl &lt;span class="nv">$PINNEDPUBKEY&lt;/span> -s &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$URL&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sed -n &lt;span class="s1">&amp;#39;/&amp;lt;token&amp;gt;/s^.*&amp;lt;token&amp;gt;\(.*\)&amp;lt;/token&amp;gt;^\1^p&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">COOKIE_HEADER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Cookie: sdesktop=&lt;/span>&lt;span class="nv">$TOKEN&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CONTENT_HEADER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Content-Type: text/xml&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://&lt;/span>&lt;span class="nv">$CSD_HOSTNAME&lt;/span>&lt;span class="s2">/+CSCOE+/sdesktop/scan.xml?reusebrowser=1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl &lt;span class="nv">$PINNEDPUBKEY&lt;/span> -H &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$CONTENT_HEADER&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -H &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$COOKIE_HEADER&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --data &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$DATA&lt;/span>&lt;span class="s2">;type=text/xml&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$URL&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="运行-2">运行&lt;/h4>
&lt;p>直接运行这个脚本，如果有 2FA 验证，在提示符后输入验证码&lt;/p>
&lt;h2 id="宿主机设置">宿主机设置&lt;/h2>
&lt;p>假设创建的虚拟机采用了 &lt;code>nat + host-only&lt;/code> 的网络模式，其中 &lt;code>host-only&lt;/code> 的地址为 &lt;code>192.168.147.188&lt;/code>。在虚拟机创建好 VPN 连接后，按照远程工作环境的网络地址 &lt;code>10.100.16.5&lt;/code>，为宿主机添加路由。&lt;/p>
&lt;p>打开&lt;code>管理员模式&lt;/code>的命令行提示符，输入以下命令，宿主机在访问 10.100.16.1 - 10.100.16.254 的所有服务器时，会通过虚拟机的网络接口收发数据，以此达到连接远程工作环境的要求。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bat" data-lang="bat">&lt;span class="line">&lt;span class="cl">route delete 10.100.16.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">route add -p 10.100.16.0 mask 255.255.255.0 192.168.147.188
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>RHEL 7 上安装 Docker CE</title><link>https://www.palfans.net/install-docker-ce-on-rhel7/</link><pubDate>Wed, 30 Jan 2019 16:55:29 -0600</pubDate><guid>https://www.palfans.net/install-docker-ce-on-rhel7/</guid><description>&lt;p>最近注册了 RedHat 的 Developer 账号，可以免费订阅一个账号用于开发测试。但是，RHEL 7 默认只能安装 Docker EE，是需要花钱的。如何才能安装社区版本的 Docker 呢？&lt;/p>
&lt;p>首先提一下， 开发者计划提供的订阅账号，本身也&lt;strong>不带技术支持&lt;/strong>，万事靠自己，所以就不用顾忌安装第三方源会失去技术支持的问题。&lt;/p>
&lt;p>按照以前的经验，RHEL 可以安装 CentOS 的对应源。但是，参照 &lt;a href="https://docs.docker.com/install/linux/docker-ce/centos/">Get Docker CE for CentOS&lt;/a>，这次会出现一个错误&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Requires: container-selinux &amp;gt;= 2.9
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>多次尝试后，终于把 Docker CE 装上了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">yum&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="n">yum&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">utils&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">yum&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">manager&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">repo&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">download&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">centos&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ce&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">repo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">yum&lt;/span> &lt;span class="n">makecache&lt;/span> &lt;span class="n">fast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">yum&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">mirror&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">centos&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">org&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">centos&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">extras&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">x86_64&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">Packages&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">container&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">selinux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">2.74&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">1.&lt;/span>&lt;span class="n">el7&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">noarch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rpm&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sudo&lt;/span> &lt;span class="n">yum&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ce&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>比官方流程多了一步，单独安装&lt;code>container-selinux&lt;/code>。这个安装包更新挺频繁的，如果链接失效，需要前往&lt;a href="http://mirror.centos.org/centos/7/extras/x86_64/Packages/">http://mirror.centos.org/centos/7/extras/x86_64/Packages/&lt;/a>查找最近打包的安装包。&lt;/p>
&lt;p>然后就是正常使用了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[palfans@home ~]$ sudo docker version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Client:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Version: 18.09.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> API version: 1.39
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Go version: go1.10.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Git commit: 4c52b90
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Built: Wed Jan 9 19:35:01 2019
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> OS/Arch: linux/amd64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Experimental: false
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Server: Docker Engine - Community
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Engine:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Version: 18.09.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> API version: 1.39 (minimum version 1.12)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Go version: go1.10.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Git commit: 4c52b90
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Built: Wed Jan 9 19:06:30 2019
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> OS/Arch: linux/amd64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Experimental: false
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>从 WordPress 迁到 Hugo</title><link>https://www.palfans.net/moving_wordpress_hugo/</link><pubDate>Fri, 25 Jan 2019 21:46:00 -0600</pubDate><guid>https://www.palfans.net/moving_wordpress_hugo/</guid><description>&lt;p>&lt;img src="https://www.palfans.net/img/migrate_to_hugo/migration.png" alt="">&lt;/p>
&lt;h2 id="起因">起因&lt;/h2>
&lt;p>说起来，都不记得这是第几次折腾 Blog 的服务器了。当初为了提高从国内访问的速度，我把搭梯子的 VPS 放在了香港的数据中心，顺便把 Blog 也放在同一台服务器以求节约成本。转眼自己肉翻这么多年，再也没有机会用那把梯子。但从美国家里访问 Blog 就慢得不能忍受，而且因为 VPS 性能不好，时不时就会出现 503 错误。思考再三，决定把站点搬回美国，反正流量可以忽略，至少要满足自己的。&lt;/p>
&lt;h2 id="选型">选型&lt;/h2>
&lt;h3 id="wordpress-的问题">WordPress 的问题&lt;/h3>
&lt;p>继续使用 WordPress 吗？我有点犹豫了。&lt;/p>
&lt;ol>
&lt;li>WordPress 体量越来越大，新版本我都不太会用了。&lt;/li>
&lt;li>网站运行速度慢。更新版本以后，常常需要等好几分钟才能打开后台。&lt;/li>
&lt;li>离线编辑器不好用。Windows Live Writer 以及后续的 &lt;a href="http://openlivewriter.org/">Open Live Writer&lt;/a> 都不再更新了。&lt;/li>
&lt;li>太流行，也就意味着目标大。总是要担心各种来自 PHP，WordPress 以及 MySQL 的安全漏洞。&lt;/li>
&lt;li>动态网站遭遇 DDoS 的时候，开销也大大高于静态网站。&lt;/li>
&lt;li>备份也不省心，定期备还占地方。&lt;/li>
&lt;/ol>
&lt;h3 id="github-pages--hugo">Github Pages + Hugo&lt;/h3>
&lt;p>突然有一天，我发现大量的码农网站都是由 &lt;a href="https://gohugo.io/">Hugo&lt;/a> 驱动的，这是个啥？&lt;/p>
&lt;p>看了一圈，它就是个轻量（只有一个文件）的静态页面生成器，读取 Markdown 文件，生成静态的 HTML 文件。把这些 HTML 文件提交到 Github Pages，就能访问了。&lt;/p>
&lt;h4 id="优势">优势&lt;/h4>
&lt;ol>
&lt;li>Github Pages 免维护。整个站点全是纯静态的页面，唯一的交互就是评论系统，也是利用了 Github 自己的 Issues。再也不用纠结服务器问题。&lt;/li>
&lt;li>Github Pages 速度快。还是因为纯静态网页的优势，至少在美国的网络环境我能秒开各个托管在 Github 的网站。&lt;/li>
&lt;li>自带 SSL 证书。Github 自动给所有 Pages 网站加上小绿锁，包括自定域名。虽然仍是基于 Let&amp;rsquo;s Encrypt 的免费证书，但每三个月自动续期，完全不用操心。&lt;/li>
&lt;li>Hugo 足够快。我试了下我总共需要生成 976 个页面，耗时 2 秒钟。&lt;/li>
&lt;li>Hugo 自带服务器端。调试非常容易。&lt;/li>
&lt;li>熟悉 git 操作。公司体量较大，现在终于开始慢慢转向使用 git 做版本控制。我也可以借此熟悉 git 的各种操作。&lt;/li>
&lt;li>熟悉 markdown 语法。&lt;/li>
&lt;li>感觉网站放在 Github 是码农的认证标识。&lt;/li>
&lt;/ol>
&lt;h4 id="劣势">劣势&lt;/h4>
&lt;ol>
&lt;li>之前 WordPress 的很多标配功能没有了，花时间调试的模板也不能直接用。&lt;/li>
&lt;li>上手曲线不够平缓，有学习门槛。&lt;/li>
&lt;li>相当依赖命令行。WordPress 可以利用在线后台更新内容，但现在就必须本地安装 Git，Hugo，Markdown 编辑器，写一篇文章就需要提交一次。虽然可以利用 Travis CI 来自动生成静态页面，但免费用户只能读取 Github 的公有库，读不了私有库，暂时没考虑。&lt;/li>
&lt;li>没想好。。。&lt;/li>
&lt;/ol>
&lt;h2 id="开干">开干&lt;/h2>
&lt;h3 id="搭环境">搭环境&lt;/h3>
&lt;p>这个就比较简单了，安装 Git，Hugo 和 Typora，连接到远端的 Github 库，Google 一下，各种教程应有尽有。&lt;/p>
&lt;h3 id="数据迁移">数据迁移&lt;/h3>
&lt;p>网上都在推荐一款插件 &lt;a href="https://github.com/SchumacherFM/wordpress-to-hugo-exporter">wordpress-to-hugo-exporter&lt;/a> ，实测是个&lt;strong>坑&lt;/strong>。在最新的 WordPress 上报函数重复定义的错误，自己段位低，解决不了。我用了一个 python 脚本 &lt;a href="https://github.com/wooni005/exitwp-for-hugo">exitwp-for-hugo&lt;/a>，需要先导出 XML，再转成 Markdown，不过执行效率非常高，几百篇文章，几秒搞定。每篇文章转换后都自带了 URL 属性，直接就能用，最后的链接保持了 domain/title 的形式，完全不影响 Google 的搜索结果。&lt;/p>
&lt;h2 id="最后">最后&lt;/h2>
&lt;p>其实这篇文章是试水，看看新建文章到底好不好使。&lt;/p>
&lt;p>就这。&lt;/p></description></item><item><title>Xfce4 failed to execute default Terminal Emulator</title><link>https://www.palfans.net/xfce4_failed_to_execute_default_terminal_emulator/</link><pubDate>Fri, 10 Aug 2018 22:48:09 +0000</pubDate><guid>https://www.palfans.net/xfce4_failed_to_execute_default_terminal_emulator/</guid><description>&lt;p>Xfce 是一款针对 Linux 系统的现代化轻型开源桌面环境，基于 GTK+2.x 开发完成。相对于传统的 GNOME 桌面来说，xfce 足够轻量化，资源占用很低，但使用体验并不差。尤其对于公司的服务器来说，偶尔需要桌面环境，但又不想安装臃肿的 GNOME，Xfce 就是个不错的选择。&lt;/p>
&lt;p>最近在公司新装了几台机器，装完发现 Xfce4 自带的终端模拟器一打开就报错。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">Failed to execute default Terminal Emulator.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Input/output error.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>从字面上看，I/O 有问题。查看了系统设置，终端设置都是正确的。Google 搜了一圈，有一个说法是终端的编码不是 UTF-8 也会导致这个问题，但我这里已经默认为 UTF-8。看日志发现如下错误：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">/usr/bin/xfce4-terminal: symbol lookup error: /usr/bin/xfce4-terminal: undefined symbol: vte_regex_new_for_match
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>symbol 找不到？前几个月安装其他机器的时候，没有这个问题。因为每次都是用 yum 在线安装，应该是版本升级造成的。看下当前用的什么版本的 vte。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ ldd /usr/bin/xfce4-terminal | grep vte
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">libvte-2.91.so.0 =&amp;gt; /lib64/libvte-2.91.so.0 (0x00007fdcd8cdd000)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ rpm -qa|grep vte291
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vte291-0.38.4-2.el7.x86_64
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装的 Linux 是 RHEL 7.3，vte291 版本是 0.38，有可能新版本的 vte 包含了缺失的 symbol。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ sudo yum install vte291
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Loaded plugins: product-id, search-disabled-repos, subscription-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Resolving Dependencies
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package vte291.x86_64 0:0.38.4-2.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package vte291.x86_64 0:0.46.2-1.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: libpcre2-8.so.0()(64bit) for package: vte291-0.46.2-1.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package pcre2.x86_64 0:10.23-2.el7 will be installed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Finished Dependency Resolution
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>新版本的 vte291 连带安装了 pcre2，再次尝试打开终端，还是报同样的错，但日志不同了。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">/usr/bin/xfce4-terminal: symbol lookup error: /lib64/libvte-2.91.so.0: undefined symbol: gtk_widget_class_set_css_name
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>又有 GTK 的 symbol 找不到，升级 GTK。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ sudo yum install gtk3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Loaded plugins: product-id, search-disabled-repos, subscription-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Resolving Dependencies
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package gtk3.x86_64 0:3.14.13-20.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package gtk3.x86_64 0:3.22.10-4.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: pango(x86-64) &amp;gt;= 1.37.3 for package: gtk3-3.22.10-4.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: libXrandr(x86-64) &amp;gt;= 1.5.0 for package: gtk3-3.22.10-4.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: glib2(x86-64) &amp;gt;= 2.49.4 for package: gtk3-3.22.10-4.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: atk(x86-64) &amp;gt;= 2.15.1 for package: gtk3-3.22.10-4.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: gtk-update-icon-cache for package: gtk3-3.22.10-4.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package atk.x86_64 0:2.14.0-1.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package atk.x86_64 0:2.22.0-3.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package glib2.x86_64 0:2.46.2-4.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package glib2.x86_64 0:2.50.3-3.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package gtk-update-icon-cache.x86_64 0:3.22.10-4.el7 will be installed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package libXrandr.x86_64 0:1.4.2-2.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package libXrandr.x86_64 0:1.5.1-2.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package pango.x86_64 0:1.36.8-2.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package pango.x86_64 0:1.40.4-1.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: harfbuzz(x86-64) &amp;gt;= 1.0.3 for package: pango-1.40.4-1.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package harfbuzz.x86_64 0:0.9.36-1.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Dependency: harfbuzz(x86-64) = 0.9.36-1.el7 for package: harfbuzz-icu-0.9.36-1.el7.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package harfbuzz.x86_64 0:1.3.2-1.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package harfbuzz-icu.x86_64 0:0.9.36-1.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package harfbuzz-icu.x86_64 0:1.3.2-1.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Processing Conflict: gtk-update-icon-cache-3.22.10-4.el7.x86_64 conflicts gtk2 &amp;lt; 2.24.29 --&amp;gt; Restarting Dependency Resolution with new changes.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package gtk2.x86_64 0:2.24.28-8.el7 will be updated
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---&amp;gt; Package gtk2.x86_64 0:2.24.31-1.el7 will be an update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--&amp;gt; Finished Dependency Resolution
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>终于又看到黑色的终端。&lt;/p></description></item><item><title>禁用 screen 的动态标题功能</title><link>https://www.palfans.net/disable_screen_dynamic_title_feature/</link><pubDate>Thu, 22 Mar 2018 21:10:38 +0000</pubDate><guid>https://www.palfans.net/disable_screen_dynamic_title_feature/</guid><description>&lt;p>GNU screen 是 Linux 上面一个非常有用的程序。它默认启用了窗口动态标题的功能，每次切换目录时，会自动用当前目录的全路径作为窗口的标题。一般情况下，这个功能很贴心，但有时候路径很长，窗口名的 tab 会显示不全而陷入混乱，我们只需要一个简明扼要的自定义标题来区分不同的窗口。&lt;/p>
&lt;p>一个临时的解决方案是在当前窗口中运行 “unset PROMPT_COMMAND”。因为 bash 通过变量 PROMPT_COMMAND 将定制的路径内容传递给 screen，把这个变量 unset 窗口名就不会再变化。如果想默认禁用这个功能，可以把这条命令加入当前用户的 ~/.bashrc，这样所有新开窗口都会生效。&lt;/p>
&lt;p>禁用动态标题后，只需要 ctrl + a + A 就能自定义窗口名。&lt;/p></description></item><item><title>Kodi 通过 SMB 连接远程 Win 10 失败</title><link>https://www.palfans.net/kodi_cannot_access_win10_via_smb/</link><pubDate>Thu, 15 Mar 2018 21:03:12 +0000</pubDate><guid>https://www.palfans.net/kodi_cannot_access_win10_via_smb/</guid><description>&lt;p>我同时在 Win 10 和 Android 平板安装了 Kodi，通过 SMB 连接到家里的 Win10 NAS 视频媒体库。之前工作正常，这两天突然发现 Android 平板连不上，每次设置好用户名密码就报连接超时（Connection Timed Out），但 Win 10 平板依然正常。&lt;/p>
&lt;p>上网搜索一圈，在 Kodi 的&lt;a href="https://kodi.wiki/view/SMB/Windows">官方维基&lt;/a>找到了答案。貌似 Win10 在某次自动升级以后，默认关闭了 SMB 1.0/CIFS File Sharing Support 的功能，需要重新手动打开。&lt;/p>
&lt;p>打开控制面板中的“添加删除程序功能”模块，或者在 Windows 开始旁边的搜索框中输入“Turn Windows feature on or off”并找到控制面板的最佳匹配项。&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/kodi_cannot_access_win10_via_smb/300px-2017-11-14_08-23-47.png" alt="">&lt;/p>
&lt;p>在 Windows 功能中找到 SMB 1.0/CIFS File Sharing Support 并激活，Windows 会安装相应的文件。重启 Win10 之后，就能重新支持 Kodi 采用的旧版 SMB 协议。&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/kodi_cannot_access_win10_via_smb/OptionalFeatures_2017-11-14_08-24-53.png" alt="">&lt;/p>
&lt;p>再次打开 Android 平板的 Kodi，通过 SMB 连接就能打开远端的媒体库了。这个问题并没有出现在 Win10 平板的 Kodi 中，估计因为 Android 版本还没有支持 SMB 2.0。&lt;/p>
&lt;p>伴随 Win10 自动升级还有另外一个坑在等着 Kodi。SMB 协议问题解决后，输入正确的 Outlook 账号也不能成功连接到远端 NAS的共享文件夹。解决方法是，升级后的 Win10 文件共享不能使用邮箱作为用户名了，需要登录到 Win10，打开 CMD 窗口，输入 whoami，会列出当前的机器名和用户名。使用这个用户名和对应的 Outlook 账号密码就能成功打开共享文件夹。&lt;/p></description></item><item><title>租租车的国际驾照认证件能用吗？</title><link>https://www.palfans.net/does-zuzuche-idp-work/</link><pubDate>Fri, 30 Jun 2017 19:24:04 +0000</pubDate><guid>https://www.palfans.net/does-zuzuche-idp-work/</guid><description>&lt;p>&lt;img src="https://www.palfans.net/img/does-zuzuche-idp-work/zuzuche_idl.jpg" alt="">&lt;/p>
&lt;p>这两天看到微信朋友圈里在宣传租租车可以免费办理国际驾照认证件（&lt;a href="http://w.zuzuche.com/tidl/">链接&lt;/a>），号称香港公证行和NAATI联合翻译认证，9国语言，权威认证，畅行全球200个国家，包括美国、加拿大、澳大利亚、以及英德意等欧洲国家。脑中升起一个问号，真是这样的吗？&lt;/p>
&lt;p>上网搜了一下，这本认证件全名叫Translation of International Driver License，由租租车和International Driving Club联合推出。它自己的说明页明确指出，该认证件根据《联合国道路交通公约》，严格按照国际标准将中国驾照翻译成9国语言，支持超过200个国家和地区租车、取车。&lt;/p>
&lt;p>看起来好像很正规。但是，这里我发现一个问题。它声称自己的法律依据是《联合国道路交通公约》，那就看看这个公约到底是什么。&lt;/p>
&lt;blockquote>
&lt;p>联合国1949年在日内瓦制定了《道路交通公约》，参加公约的国家在道路规范、标志、信号、交通规则以及跨国运输车辆的规格等方面采取相似的标准，同时为成员国公民在其他国家驾驶车辆提供方便，由缔约国政府或其授权机构根据公民的需要，依据其有效的国内驾照以多种文字颁发一份许可证，证明该公民的国内驾照为合法文件。对官方语言与颁发驾照地不同的国家，该许可证的好处更加突出：驾车人同时出示本国驾照和IDP，就可以迅速准确地核实驾车人的身份和驾驶资格，给执法机关、交通运输相关行业例如租车公司和保险公司带来很大方便。尽管联合国的公约文字上把IDP称为“国际（驾驶）执照”，但是它必须与持有人的国内驾照一同使用，仅仅有IDP既不能在外国也不能在本国合法开车。&lt;/p>
&lt;p>该公约在1968年修订，文本从原来只有英法两种文字变为当时联合国法定的五种文字，篇幅也从118页增加到466页。迄今在新公约上签字的有82个国家和地区，其中70个已经递交了批准书。但是因为1949年公约成员国还有一半以上没有签署和批准新的公约，而且公约的很多基本规定，包括国际驾照的章节并没有大的变化，所以国际驾照的规定在这两个公约的成员国都适用。——美国国务院Blog《雾谷飞鸿》&lt;a href="https://blogs.america.gov/mgck/2012/04/24/permit/">链接&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://www.palfans.net/img/does-zuzuche-idp-work/Countries_that_Recognize_International_Driving_Permit.png" alt="Countries_that_Recognize_International_Driving_Permit">&lt;/p>
&lt;p>深蓝：国际道路交通公约签约国和地区 浅蓝：非签约国但承认国际驾驶执照&lt;br>
图片来源：&lt;a href="https://zh.wikipedia.org/wiki/%E5%9C%8B%E9%9A%9B%E9%A7%95%E9%A7%9B%E5%9F%B7%E7%85%A7">维基百科-国际驾照词条&lt;/a>&lt;/p>
&lt;p>我们能很轻松的发现，中国既不是深蓝，也不是浅蓝。这说明中国根本不承认国际驾照。在广东生活的朋友，对香港过境车挂中港双牌照应该已经司空见惯，这也是因为中国不是《道路交通公约》签约国，不认可该公约，致使所有外国和地区登记车辆，必须悬挂单独的中国牌照。&lt;/p>
&lt;p>租租车这本认证书说是由香港公证行和NAATI（澳大利亚全国翻译认证机构）联合翻译认证。因为香港和澳大利亚都是《国际道路交通公约》签约国和地区之一，那么认证可以通过挂靠香港或者澳大利亚来实现合法使用吗？结论仍然是不行。国际驾照要求必须由居住国政府授权机构针对持有的居住国驾照来签发，换句话说，中国驾照对应的国际驾照必须由中国政府授权的机构签发才可能是合法有效的，但很明显中国都不是签约国，根本不可能有这么一份合法的认证书。所以不管租租车合作的这个International Driving Club是个什么背景的国际组织，它都没有资格签发任何和中国驾照有关的国际驾照认证。&lt;/p>
&lt;blockquote>
&lt;p>最后提醒大家一点，就是有人向非日内瓦《道路交通公约》缔约国公民兜售“国际驾照”，有的还打出与美国“权威机构”合作、甚至作为这种机构代理的旗号，而且说要把公民的驾照资料送到美国核实，然后在美国制作国际驾照，再快递回国交给当事人，所以收费高昂（美国办理国际驾照现在收费15美元）。知道了公约附件七的规定，就应该清楚这些都是不对的，这样得到的所谓“国际驾照”，与把该国驾照翻译成英文、然后加以公证的作用没有什么区别。这种骗人的机构有的还宣称可以办理有效期5年的“国际驾照”，那更是荒唐，因为联合国的公约明白无误地规定，国际驾照有效期只有一年。。——美国国务院Blog《雾谷飞鸿》&lt;a href="https://blogs.america.gov/mgck/2012/04/24/permit/">链接&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>所以凭租租车这本国际驾照，只可能在那些承认翻译公证后的中国驾照有效的国家和地区使用，但这不一定适合所有《道路交通公约》的签约国，需要对每一个国家的专门法律条文进行研究。&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/does-zuzuche-idp-work/image.png" alt="">&lt;br>
图片来源：穷游问答 &lt;a href="http://ask.qyer.com/question/962637.html">链接&lt;/a>&lt;/p>
&lt;p>从租租车的回答来看，这是相当不负责任的。他们只和车行供应商多次确认，而不是自己去研究相关的法律条文或者咨询专业律师，如果真的出了什么意外，车行供应商是不会帮你向执法部门做任何解释的。&lt;/p>
&lt;p>具体到中国驾照能否在美国合法开车，这个问题太复杂，因为美国50个州都有自己不同的规定，而且一直在不断调整。因为常年生活在德州，2013年我给Texas DPS（得克萨斯州公共安全部门）发过一封邮件，询问我持有中国驾照能否在德州境内合法驾驶，回复如下：&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>DONOTREPLY_CustomerSupport&lt;/strong> &amp;lt;&lt;a href="mailto:DONOTREPLY_CustomerSupport@dps.texas.gov">DONOTREPLY_CustomerSupport@dps.texas.gov&lt;/a>&amp;gt;&lt;/p>
&lt;p>Thank you for giving the Department the opportunity to respond to your email inquiry.&lt;/p>
&lt;p>You can drive in Texas with your license from China for up to ninety days, however, if you have an International license you can drive in Texas for up to one year. You must have your Chinese driver license when you drive in Texas at all times.&lt;/p>
&lt;p>I hope this information is helpful. Please do not hesitate to contact Customer Service at &lt;a href="http://www.dps.texas.gov/DriverLicense/customer%20service/defaults.aspx">www.dps.texas.gov/DriverLicense/customer service/defaults.aspx&lt;/a> or &lt;a href="http://www.utcssa.net/tel:512-424-2600">512-424-2600&lt;/a> should you have additional questions or need further assistance.&lt;/p>
&lt;/blockquote>
&lt;p>回复的重点是凭中国驾照可以在德州合法驾车最多90天，如果有对应的国际驾照，则可以驾车最多一年。&lt;/p>
&lt;p>我专门把这封邮件打印出来，和中国驾照放到一起，当作我在德州合法驾驶的有效证明，一直到我取得了德州的驾照为止。但这里有个问题，很明显DPS的工作人员并不知道中国不是《道路交通公约》的成员国，否则他不应该提到国际驾照的问题。&lt;/p>
&lt;p>写这篇文字的时候，我又去查了下德州DPS的网站，发现规定又变了。&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Adults (18 and Older)&lt;/strong>&lt;br>
Applicants who have a valid, unexpired driver license from another U.S. state, U.S. territory, or from Canada must surrender their out of state/country driver license and are not required to take the knowledge or skills exams. Texas also has license issuance reciprocity with France, Germany, South Korea, and Taiwan only. Applicants who have a valid, unexpired driver license from one of these countries are not required to take the knowledge or skills exams if they surrender their out of country driver license. However, if the applicant does not wish to surrender their out of country driver license, they must take and pass all required exams. The reciprocity only applies to passenger vehicles, not commercial vehicles or motorcycles. Foreign licenses not in English or Spanish will need to have a translation service or their consulate translate the information on the driver license prior to arriving. This translation requirement also applies for marriage licenses.&lt;/p>
&lt;/blockquote>
&lt;p>在德州合法的外国驾照&lt;strong>只针对&lt;/strong>德州的互惠国，即**加拿大、法国、德国、韩国和台湾，**甚至连其他的《道路交通公约》签约国和地区都不行，更别提中国驾照。&lt;/p>
&lt;p>不过以我的经验，因为台湾在官方文件里通常写作 China(Taiwan)，很多美国人包括执勤的交通警察都分不清 China(PRC)和China(Taiwan)的区别，统一了一个中国的认识，所以在车行租车、路上警察查询时都能顺利过关。但是，这有非常大的隐患。一旦出了一个稍大的事故，需要出庭的时候，法官通常能发现你无证驾驶这个事实，即使事故本身责任判定对你有利，也会面临很大的政策风险，至少保险公司可以主张不赔付任何损失，还有可能罚款和监禁。&lt;/p>
&lt;p>最后我们不禁想问，为什么中国现在汽车拥有量和出国旅游人数年年攀升的前提下，还是不想加入《道路交通公约》来为自己公民争取一些出行便利呢？我臆测的一个原因是，通过外交努力也没办法替换掉大陆建国前就已经加入公约的台湾（中华民国），索性就完全不吊它了。&lt;/p></description></item><item><title>银行账户被盗</title><link>https://www.palfans.net/bank_account_compromised/</link><pubDate>Thu, 22 Jun 2017 16:57:37 +0000</pubDate><guid>https://www.palfans.net/bank_account_compromised/</guid><description>&lt;p>过去的一整天，我都在忙于更改各种账户的银行资料。因为它们关联的银行账户被盗，产生了好几笔支付交易。在银行的要求下，我只能关掉这个问题账户，重新开一个新账户，并手动更新到所有关联账户。&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/bank_account_compromised/0929072242721.jpg" alt="">&lt;/p>
&lt;p>8年来，每个月我会抽一小时的时间对所有账户交易流水进行核对。这个月，我看到有两笔来自Paypal的扣款很陌生，因为我小儿子刚好在那天出生，我一整天都待在医院，根本没有时间接触电脑和手机进行任何消费活动。我立刻打开Paypal，发现在那天确实没有产生任何交易记录。我第一反应就是账户被黑了。&lt;/p>
&lt;p>Paypal这边完全无信息可查，我又返回银行的交易记录查询明细，看到这两笔交易都来自同一个人：PAYPAL DES:TRANSFER ID:xxxxxxxxx INDN:TRINA VONHAGEN CO ID:PAYPALSD22 WEB，姓名是TRINA VONHAGEN，Paypal账号是PAYPALSD22。这个时候我突然反应过来，刚才登录网上银行时，提示“账户密码错误次数过多，账户被锁”，说明对方也在尝试直接登录我的银行账户。不幸中的万幸是，我一直使用LastPass来为所有网络服务随机生成含特殊字符、数字、大小写字母的18位密码，每个账号密码都不同，完全杜绝撞库。在LastPass主密码安全的前提下，通过暴力破解的方式几乎是不可能的。&lt;/p>
&lt;p>接下来需要联系Paypal。当时已经是美国中部时间晚上11点，Paypal的客服人员理论上应该下班了。很幸运，鬼使神差下，我平板电脑上绑定的居然是中国Paypal的账户。我在不知不觉中拨通了Paypal上海的客服电话。客服小姐非常耐心听完整个过程，然后说好像没查到你这个账户关联了美国的银行。我一下想起来，登错账号。这时客服没有直接拒绝我，而是说按照规定我的问题应该交由美国部门来处理，但这个问题涉及账户被盗，她可以破例帮我尝试跨部门查询。查了我的美国Paypal的账户名，发现我的银行支票账户被之前提到这个Paypal账户关联了，除了已经清账的两笔，还有6笔其他的交易正在等待处理，不过这些交易还没有同步到银行系统。客服小姐立刻对问题账户做了警告标识，冻结了未生效的6笔交易，告知我已生效的2笔交易，他们会在走完查询流程后全额返还。不过因为她不了解美国银行的处理方式，建议我在第二天再次联系美国Paypal和银行。&lt;/p>
&lt;p>我又尝试拨打银行的客服电话，发现他们居然24小时工作，这在美国好少见。客服小姐听完描述，肯定的告诉我，账户资料泄露了。虽然可以冻结所有来自Paypal的付款请求，但是对方仍然可以在其他地方使用我的账户。唯一的方法是关掉现在的账户，再新开一个，把所有资金转移过去。因为这个账户关联着我日常生活的各个账号，我想了解是否必须这样做，否则太费时间了。客服小姐说，一切取决于我的决定，银行只是建议。而且目前没有更安全的方式来保证当前账户的安全。另外，我们的通话全程录音，如果因为我没有采纳银行的建议而导致今后资金损失，银行会排除所有赔偿责任。看来，华山只剩一条路了。然后她说，已经帮我提交了盗刷问题单，这两笔交易会立刻取消，款项会返还账户。最后她帮我对账户做了挂起操作，具体实现方式是直接给我账户添加了一笔$888888.88的欠款，这样我的账户就失去了付款能力。&lt;/p>
&lt;p>第二天一早，我就拨打美国Paypal的客服。他的回答和银行很类似，这两笔交易由银行负责追查，银行后台会和Paypal进行沟通，不需要客户自己操作。这时我心中有一个巨大的疑问，我的银行账户是怎么被关联到其他人的？Paypal的客服翻来覆去只是强调我的信息泄露了，Paypal本身不会出现这种错误，我需要反思自己使用过程有什么安全隐患。&lt;/p>
&lt;p>下午到银行柜台，新开账户，转账，等等。大概20分钟完成全部程序。这时，柜员提醒我说，账户又多了4笔支付请求，不过被银行直接拒绝了。同时被盗刷的两笔交易的退款也已经到帐。目前看来，仍然是个Happy Ending。&lt;/p>
&lt;p>对于任意添加银行账户这个问题，我仍然相当困惑和恐惧。和银行柜员讨论了一下，她认为这是不可能的。通常情况添加账户有两种模式，一个是通过网上银行用户名密码直接检验账户，一个是给这个银行账户存入两笔小额存款，然后校验存款金额来检验账户。我后来重新在Paypal实验了一下，Paypal采用的存钱校验的方式。这就很奇怪了，对方如何知道Paypal在我的银行账户存了多少钱呢？我很早就取消了纸质账单寄送，通过查询Gmail和银行网站登录信息，都没有异常。我只能说，Paypal的系统一定存在某个我还不知道的漏洞。&lt;/p>
&lt;p>最后，花了大半天时间，更新完所有交易信息。接下来还需要等待一个月左右，确认这些交易信息都真正生效了才能去掉我那888888.88的负债，彻底关闭问题账户。&lt;/p>
&lt;p>总结：&lt;/p>
&lt;ol>
&lt;li>美国银行业确实比国内银行成熟，应对盗刷赔偿问题，敢于承担责任。我不是很敢相信，国内能赔付得如此干脆快速。&lt;/li>
&lt;li>中国Paypal的客服态度比美国Paypal好了不止10倍。美国Paypal客服没有帮我解决任何问题，只是强调他们没有问题。&lt;/li>
&lt;li>支票真的不能随便撕，鬼知道有没有什么漏洞可以越过所有校验&lt;/li>
&lt;li>我再不会对外使用一次我的主银行账户。以后需要支票的话，我也会转账到一个小额账户，然后开支票。&lt;/li>
&lt;li>能用信用卡尽量用信用卡。&lt;/li>
&lt;li>现金都比支票安全，上面不会印着你的账户信息、姓名、住址和电话。&lt;/li>
&lt;li>定期对账很有必要，如果这次不是常规对账，我根本不可能发现对方采用的每次几十美金小额支付的细水长流的盗窃手法。&lt;/li>
&lt;li>银行的挂起账户功能一定是华人产品经理设计的，才会如此的偏好“8”。&lt;/li>
&lt;/ol></description></item><item><title>Blog 更换服务器</title><link>https://www.palfans.net/blog-changed-server/</link><pubDate>Mon, 05 Jun 2017 20:49:13 +0000</pubDate><guid>https://www.palfans.net/blog-changed-server/</guid><description>&lt;p>算起来，从2005年开始写这个Blog，累计换了好几次服务器。从Windows主机到Linux主机，从朋友托管机器到专业空间服务商，从相当业余的myrice到老牌空间hostgator，在不断折腾中慢慢熟悉了域名，DNS，虚拟空间等各种概念和网站知识。2010年搬到&lt;a href="http://www.laoxuehost.com/">老薛主机&lt;/a>，因为不想折腾了。一晃七年，不能说没有遇到问题，比如网站经常会在中国的半夜出现MySQL服务器挂死的问题，为此我提交了好多问题单。不过一旦提交问题单，解决都非常快。马上新一年的账单又要来了，不过鉴于现在打理网站的时间少之又少，Blog基本处于停止更新的状态，一年估计能写一篇，所以即使年费才几十块钱，也不想再续费了。考虑到家里常年开着一台惠普的小服务器，反正闲着也是浪费电，索性在周末把全站从虚拟空间转移到自家的机器上。再见了，老薛。&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/blog-changed-server/server.jpg" alt="">&lt;/p>
&lt;p>picture from &lt;a href="https://www.vpnranks.com">vpnranks&lt;/a>&lt;/p>
&lt;p>搬家过程没什么挑战，Docker的出现让部署变得异常容易。开了4个容器，分别放数据库，Nginx，PHP-FPM和FTP，直接导入从原站拿到的备份，总耗时不超过2小时。唯一的坑在部署Let&amp;rsquo;s Encrypt的SSL证书。因为web服务器放在容器里，没有公网IP地址，所以不能采用certbot全自动模式来获取证书。看了下文档，certbot支持通过带manual参数来更新DNS TXT记录的方式来验证域名从而获取证书，命令很简单&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">certbot certonly --manual --preferred-challenges=dns --manual-auth-hook /etc/letsencrypt/authenticator.sh --manual-cleanup-hook /etc/letsencrypt/cleanup.sh -d &amp;lt;domain_name&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>官方文档提供了一个authenticator.sh的&lt;a href="https://certbot.eff.org/docs/using.html#pre-and-post-validation-hooks">示例&lt;/a>，用来调用Cloudflare DNS API。但我在这里被坑了好久。逼不得已一行行阅读代码，终于发现问题。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Strip only the top domain to get the zone id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DOMAIN=$(expr &amp;lt;span style=&amp;#34;color: #0000ff;&amp;#34;&amp;gt;match&amp;lt;/span&amp;gt; &amp;#34;&amp;lt;span style=&amp;#34;color: #8b0000;&amp;#34;&amp;gt;$CERTBOT_DOMAIN&amp;lt;/span&amp;gt;&amp;#34; &amp;#39;.*\.\(.*\..*\)&amp;#39;)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这句正则式需要匹配的域名包含两个“.”，否则返回值为空。如果打算为根域名（abc.com）安装证书，certbot没法获取域名信息，会抛异常。找到问题就好办了。计算机技术发展这么多年，以我的水平能遇到的问题都不能算真正的问题。正则式不好用，就换用dig工具来获取SOA地址，然后就能正常验证域名并获得Let&amp;rsquo;s Encrypt签发的证书。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">DOMAIN=$(dig soa &amp;#34;&amp;lt;span style=&amp;#34;color: #8b0000;&amp;#34;&amp;gt;$CERTBOT_DOMAIN&amp;lt;/span&amp;gt;&amp;#34; | grep -v ^\; | grep SOA | awk &amp;#39;{&amp;lt;span style=&amp;#34;color: #0000ff;&amp;#34;&amp;gt;print&amp;lt;/span&amp;gt; $1}&amp;#39;;)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Oneplus One （一加手机）加密后如何升级系统</title><link>https://www.palfans.net/how-to-upgrade-encrypted-oneplus-one/</link><pubDate>Sat, 14 Nov 2015 06:24:00 +0000</pubDate><guid>https://www.palfans.net/how-to-upgrade-encrypted-oneplus-one/</guid><description>&lt;p>一年多以前从红米换成一加Oneplus One 64G版本，高通骁龙801的CPU，2G的运存，使用很顺手，终于体验了一把旗舰机的感觉。一加公司比较厚道，机器可以很轻松的通过&lt;a href="http://www.wugfresh.com/brt/">Bacon Root Toolkit&lt;/a>工具一键解锁和Root。&lt;/p>
&lt;p>因为公司邮件系统的强制安全策略，所有接入系统的移动终端都会要求加密，但是一加国内版用的是ColorOS系统，加密功能貌似被取消了，而国际版的CyanogenMod系统却能正常加密，毫不犹豫刷成CM并成功加密。&lt;/p>
&lt;p>但是问题来了，CM系统更新非常频繁，经常收到OTA升级通知，每次点击更新会在下载完升级包之后重启到Recovery的机器人界面，然后升级失败，怎么回事？&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/how-to-upgrade-encrypted-oneplus-one/OnePlusOneAndroid5.1.1LollipopCyanogen.jpg" alt="">&lt;/p>
&lt;p>仔细看了下错误日志，问题应该出在加密上。安卓系统加密时把/data分区进行加密，而其他的分区都没有加密。手机在正常开机状态下，升级包文件都下载到/data分区保存，但不知道什么原因，进入Recovery后并不能正确的解密该分区，CM11S和CM12S都是这个问题，于是/data加载失败，升级肯定也就不能继续。&lt;/p>
&lt;p>通过反复尝试，我发现有三种方法可以成功升级。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>adb sideload update&lt;br>
把升级包下载到电脑上，把手机和电脑用数据线连接起来，adb sideload就能从电脑读取升级文件后直接写入手机的/system分区，完全不访问/data，就不再有加密分区的限制。Bacon Root Toolkit提供了一键adb sideload的功能，点击下图按钮后，按照软件提示进行操作即可写入数据。&lt;br>
&lt;img src="https://www.palfans.net/img/how-to-upgrade-encrypted-oneplus-one/sideload.jpg" alt="">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>usb otg update&lt;br>
将升级包复制到优盘中，通过otg线连接到手机，重启进入Recovery后，加载usb-otg分区。因为usb-otg也是未加密状态，可以直接访问，所以可能正常升级。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Custom Recovery&lt;br>
给手机刷一个Custom Recovery，我选的是twrp 2.8.7.0，输入密码后能正确解密/data分区，就不需要电脑、数据线和otg线，直接手机下载升级包并升级。在这里我走了一些弯路。Bacon Root Toolkit提供刷写一个临时Custom Recovery的功能，重启自动恢复为官方Recovery。看起来挺美好，但是，虽然这个Custom Recovery也是twrp 2.8.7.0，它却不能正常解密/data，即使密码正确，也只能反复让你输入密码。所以一定要刷一个永久的Custom Recovery。当然，通过Bacon Root Toolkit随时可以刷回官方Recovery。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>似乎很完美？其实并不全是。如果是rooted手机，升级会失败……&lt;/p>
&lt;p>按常理root并不会影响OTA升级，但rooted的一加手机/system分区的校验码发生变化，升级包的脚本校验后，造成无法升级。所以如果手机root了，就没有办法使用增量包升级。很多人推荐的方法是等新版本的全量包发布，不过CM的全量包要比增量包晚很久才出，每天看着状态栏的升级提示却不能升级会很烦心。这里有个小技巧，下载前一版本的全量包和新版本的增量升级包，用前面的三种方法先刷全量包恢复成官方版本，再刷增量升级包，然后再一键root，就能提前升级到最新系统。&lt;/p></description></item><item><title>漫游在美国 - 如何打电话</title><link>https://www.palfans.net/roaming_in_us_call/</link><pubDate>Fri, 18 Jul 2014 18:38:03 +0000</pubDate><guid>https://www.palfans.net/roaming_in_us_call/</guid><description>&lt;p>来到美国5个月了，往国内打电话肯定是日常生活的一个重要组成部分，今天总结下这几个月的经验。&lt;/p>
&lt;p>出国前，我为我的中国移动号码办理了国际漫游。因为是全球通用户，整个办理流程比较简单，直接用手机拨打10086申请即可，每次申请的时效是一年，不需要预存保证金。漫游期限快到时，直接在国外拨打中国移动的境外漫游免费客服号码+8613800100186，请客服人员帮你转接到号码归属省的移动客服办理漫游延期。只有用中国移动号码拨打这个号码才享受免费优惠。现在中国移动针对美国、韩国、新加坡等180个国家和地区推出了漫游123的资费政策，即根据不同的漫游国家和地区，漫游主被叫资费分别为每分钟0.99元，1.99元和2.99元。客观的说，这个资费已经很便宜了，尤其是美国被归在1元区。还记得去阿曼出差时，这个资费政策还没执行，给国内打电话18元一分钟，每次打电话都要做充分的思想准备，现在也划在3元区里，降幅惊人。&lt;/p>
&lt;p>但是，如果完全用中国移动的号码接打所有电话，即使已经1元区了，费用还是不便宜，而且很多线上线下服务需要登记美国国内号码，所以还是得弄个本地号码。现在美国各个运营商的资费基本都是无限国内通话，无限国内短信，限量LTE流量，无限GPRS流量，每个月40-60美金，以美国的国民收入来算，比较便宜。&lt;/p>
&lt;p>美国国内通话搞定了，接下来是中国的国际长途部分。&lt;/p>
&lt;p>&lt;strong>打电话回国&lt;/strong>&lt;/p>
&lt;p>美国的电信市场充分开放，各类电话服务蓬勃发展，电话卡、回拨、转接号层出不穷。我选择了 &lt;a href="http://www.skype.com/zh_CN/">Skype&lt;/a> 和 &lt;a href="http://www.localphone.com/?rb=s63mql8XCPsTT7p1LYTtRczRXG6bpzkXVvpejFFFXvA">Localphone&lt;/a> （之后简称 LP）。这俩都是老牌的网络电话供应商，其中 Skype 的名气更大一些，现在已经是微软的资产。我在折腾 &lt;a href="http://www.palfans.net/?s=voice">Google Voice&lt;/a> 的时候开始接触 LP，算下来5年了，这个公司的服务一直非常稳定，值得信赖。这两个产品比较一下，拨回中国的费率都差不多，Skype 是1.1美分，LP 是1.2美分，都不到一毛钱人民币每分钟。如果使用它们的包月套餐，费率就更低。它们都是基于VOIP的产品，通话效果依赖于拨打时的网络环境， Skype 采用了P2P的传输技术，理论上在窄带宽和渣网络时能最大限度保持通话质量。但凡事没有绝对，经常会出现在同一个场景，Skype 通话质量不行，但 LP 清晰无延迟的情况，反之亦然。所以这俩可以都备上，互为补充。Skype 和 LP 都提供直拨号码转接服务，即为对方的中国号码分配一个当地号码，直接用美国手机拨打此当地号码，即可拨回中国，国际通话部分的费率不变，即使没有移动网络也能拨打，非常方便。但是 Skype 的这个服务每次拨打时会加收一笔4.9美分接通费，而 LP 没有，所以短暂通话 LP 划算，通话时间长，Skype就更划算。&lt;/p>
&lt;p>&lt;strong>接国内电话&lt;/strong>
沟通不能单方面，如何让国内的亲朋能方便的联系我呢？现在中国移动、中国联通和中国电信三家都分别推出了各自的服务来满足这个需求。&lt;/p>
&lt;ul>
&lt;li>中国移动：&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>中国移动推出了 &lt;a href="https://www.jegotrip.com.cn/">无忧行&lt;/a> 服务，需要智能手机（Android/iPhone）安装应用，通过移动网络或WiFi连接服务器。最大的卖点是可以租一个中国移动的号码（大陆和香港都可以，月租不同），也可以直接绑定国内现有的中国移动手机号，每月月租1美金。在应用在线的情况下，所有拨打到该移动号码的电话，都会通过网络转到 Jego 应用来免费接听。从2014年7月16日开始，Jego 也支持接收该移动号码收到的所有短信，相当于完全没有国际漫游费用。也可以从应用内直接拨打电话回国，能在接听方的手机上正确显示自己绑定的移动手机号码。这一点是 Skype 和 LP 想做但一直无法实现的功能。用它俩打回国，来电号码显示永远都稀奇古怪甚至『受限号码』，很像诈骗号码，很多时候对方都不愿意接听这种电话。据 Skype 解释，来电号码 （Caller ID）在中国大陆的显示问题，主要由国内电信运营商垄断造成，在其他大部分国家和地区都能正常使用。对于这点，我只能呵呵了。Jego接听免费，拨打费率是2.2美分，比 Skype 和 LP 贵，缺点是必须依赖互联网和智能手机应用，能收短信不能发短信。另外交费系统和现有移动系统完全分开，需要美金，好在可以Paypal。&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>中国联通：&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>中国联通推出了&lt;a href="http://www.wo-call.com/">沃信&lt;/a>服务，英文很奇葩，『我靠』，也不知道是谁想出来的。功能点基本上和 Jego 类似，甚至连应用程序的界面都雷同，丑到没朋友。不过沃信只能注册一个新的河北联通的手机号码，而不能绑定其他省的已有联通号码。这点不如 Jego 灵活。但沃信使用联通交费系统，用人民币交费，月租10元，打电话0.15元，发短信0.1元，这比 Jego 稍稍方便些。缺点和 Jego 一样，依赖互联网和智能手机应用。&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>中国电信：&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>中国电信北美公司搞了个&lt;a href="https://www.chinavirtualnumber.com/home.dhtml">一卡双号&lt;/a>服务，注册一个上海电信的手机号码，绑定到任意美国和加拿大的固话、手机号码。国内拨打这个上海电信号码，直接转接到美国这边的手机、固话，完全没有国际长途部分的费用，而且全程走的都是中美间的国际电话线路，不依赖互联网，不需要智能手机，语音效果和直拨国际长途完全一样，是三家公司的产品中通话质量最高最稳定的解决方案。月租9.99美金，无限时接听，现在还送每个月200分钟拨回中国的国际长途时长，不过主叫采用VOIP电话，需要拨打转接号，而且通话质量和接听国内来电完全不能比。另外，这个上海电信的号码，完全不能接收短信。&lt;/p>
&lt;/blockquote>
&lt;p>一开始我用的中国电信的服务，接听还好，但主叫质量很不稳定，拨打转接号后无法调用电话簿的联系人记录，需要手工输入被叫号码，不方便，那200分钟国际长途几乎没用完过。加上每月10美金的固定开销，于是放弃。因为我从来没用过联通的手机，所以也没有尝试沃信。现在使用 Jego，虽然也是VOIP的一种，但是不论主叫还是被叫，通话质量都非常不错，语音清晰，也感觉不到延迟。另外一个好处是，加入了亲情计划或者企业短号的移动号码，短号依然可用。现在国内的亲戚朋友，仍然可以只拨3个数字就拨通电话，而通话也归到亲情计划的分钟数内，免费通话。&lt;/p>
&lt;p>之前不了解这些电话服务，选手机都只考虑双卡双待，现在完全没有必要了，只要是个智能手机都能正常安装应用，接听国内号码来电。从这点来说，也能看到国内电信三巨头正在谋求改变。虽然受限于国内通信管制，在国内没有什么亮眼的服务，但是一旦跑到自由市场经济的环境中，也在积极探索新鲜事物。只求国内的环境也能早点向正面的、积极的方向发展。&lt;/p></description></item><item><title>为VirtualBox中的CentOS扩展Swap空间</title><link>https://www.palfans.net/extend_swap_space_in_virtualbox/</link><pubDate>Mon, 02 Jun 2014 18:30:56 +0000</pubDate><guid>https://www.palfans.net/extend_swap_space_in_virtualbox/</guid><description>&lt;p>在VirtualBox中安装好CentOS后，会发现默认的Swap空间大小是根据初次配置的可用内存来生成的，正常使用足够。但是，如果需要安装Oracle，它要求最少2GB的交换空间，这时就需要扩展交换空间。&lt;/p>
&lt;p>首先运行swapon命令查看交换空间大小，如果得到的大小少于&lt;strong>2097152&lt;/strong>，就需要增加交换空间。&lt;/p>
&lt;pre>&lt;code>swapon -s
&lt;/code>&lt;/pre>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/1.png" alt="">&lt;/p>
&lt;p>1. 首先，在VirtualBox中新增一块硬盘&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/2.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/3.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/4.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/5.png" alt="">&lt;/p>
&lt;p>2. 格式化新增的硬盘&lt;/p>
&lt;pre>&lt;code>fdisk -l
fdisk /dev/sdb
&lt;/code>&lt;/pre>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/6.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/7.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/8.png" alt="">&lt;/p>
&lt;p>3. 转换为Swap space&lt;/p>
&lt;pre>&lt;code>mkswap /dev/sdb1
swapon /dev/sdb1
swapon -s
&lt;/code>&lt;/pre>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/9.png" alt="">&lt;/p>
&lt;p>4. 让CentOS开机自动加载新增的交换空间&lt;/p>
&lt;pre>&lt;code>vi /etc/fstab
&lt;/code>&lt;/pre>
&lt;p>&lt;img src="https://www.palfans.net/img/extend_swap_space_in_virtualbox/10.png" alt="">&lt;/p></description></item><item><title>垃圾来袭</title><link>https://www.palfans.net/fu_kspam/</link><pubDate>Fri, 29 Nov 2013 07:50:03 +0000</pubDate><guid>https://www.palfans.net/fu_kspam/</guid><description>&lt;p>&lt;img src="https://www.palfans.net/img/fu_kspam/stopspam.jpg" alt="stopspam">&lt;/p>
&lt;p>最近发现网站所在的主机资源占用很严重，长期超过80%，经常触发资源达到限制的508错误。一开始没注意，结果月底主机带宽用光。这么多年，这个主机的带宽从未用完过一半，这个月居然用完了！于是开始仔细看访问日志，发现一大堆来自福建莆田的IP，频繁刷新各种页面，目的不明。主机商协助增加了3次，每次1G的流量，都很快被搞完。&lt;/p>
&lt;p>主机商建议使用CDN来分摊流量和主机负载。于是先把网站弄到&lt;a href="http://www.cloudflare.com/">CloudFlare&lt;/a>，一开始很给力，网站访问速度大幅上升。没多久，发现访问网站失败，翻墙再试，正常得很。看来CloudFlare被盯得很紧，我有幸分配到了一个被加持过的IP。然后看到&lt;a href="http://www.anquanbao.com/">安全宝&lt;/a>也有类似的CDN服务，仍然是免费的。注册完发现，需要备案，否则只能分配一个境外IP。备你妈的案啊！&lt;/p>
&lt;p>不过再看看安全宝提供的境外节点，貌似是个日本IP，国内访问速度还不错。我又开始动脑筋了，把两个CDN都用上！&lt;a href="http://www.dnspod.cn">DNSPOD&lt;/a>就是干这个的。对比了一下两个CDN针对国内国外的访问速度，最后把国外线路和移动线路的分到CloudFlare，把国内其他线路都分到安全宝。&lt;/p>
&lt;p>速度上去了，缺点是大访问量仍然存在，尤其是刚刚转CDN，它们的各个节点都要来缓存网页。这个节骨眼上，主机商赠送的流量根本不够折腾，只好先想办法把那些垃圾都找出来，全部屏蔽掉，熬到下个月再说。&lt;/p>
&lt;p>cPanel本身支持添加IP黑名单，但是一个一个加，工作量太大。另外一个方法就是自己改.htaccess文件，把垃圾来源IP都放里边，我把目前整理好的IP段都列出来，99%来自福建，其中又有90%来自莆田。于是我直接屏蔽掉整个IP段。这里只能对莆田可能的访问者说抱歉了。当然，这个抱歉也没法成功看到，hoho&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;lt;Files 403.shtml&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">order allow,deny
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">allow from all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;/Files&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 108.162.216.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.102.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.106.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.107.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.113.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.114.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.115.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.68.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.69.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.70.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.72.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.85.104.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.86.165.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.86.167.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.86.185.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.13.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.34.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.35.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.46.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.52.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.53.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.60.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.61.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 110.89.9.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 112.111.160.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 112.111.188.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 112.111.189.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 112.111.190.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.117.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.118.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.119.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.192.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.193.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.195.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.200.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.201.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.202.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.203.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.248.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.252.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.254.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.76.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.77.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.78.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.79.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.85.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 117.26.86.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.33.240.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.33.241.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.33.242.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.33.243.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.208.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.210.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.211.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.216.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.226.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.228.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.234.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.238.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.37.243.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.40.148.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.40.149.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.40.150.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.43.10.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.43.26.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.43.30.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.43.4.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.43.6.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 120.43.8.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.196.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.198.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.199.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.215.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.239.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.242.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.243.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.247.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.205.248.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 121.207.140.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 123.116.37.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 139.227.62.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 14.18.171.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 175.42.92.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 175.44.59.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 182.118.20.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 182.118.21.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 182.118.22.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 182.118.25.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 218.85.146.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 218.86.50.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 218.86.51.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 220.161.96.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 220.161.127.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.205.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.206.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.207.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.212.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.214.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.225.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.228.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.229.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.238.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.246.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 222.77.247.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.150.223.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.150.229.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.128.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.160.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.161.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.162.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.163.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.184.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.185.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.186.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.187.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.209.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.218.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.219.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.228.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.233.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.249.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.250.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.153.251.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.154.206.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.195.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.197.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.205.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.209.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.211.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.229.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.231.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.238.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 27.159.254.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 36.248.168.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 36.248.171.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 36.250.182.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 58.23.237.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 59.58.113.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 59.58.136.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 59.58.137.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 59.58.138.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 59.58.139.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 59.58.158.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deny from 60.168.18.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>WLW发布Wordpress时xmlrpc.php 404问题</title><link>https://www.palfans.net/wlw_wordpress_xmlrpc_404/</link><pubDate>Sun, 09 Sep 2012 07:03:45 +0000</pubDate><guid>https://www.palfans.net/wlw_wordpress_xmlrpc_404/</guid><description>&lt;p>用WLW连接Wordpress发布文章时，总是遇到找不到xmlrpc.php的问题，直接在浏览器中输入完整地址，也是得到404错误。但是通过FTP能看到这个文件就放在那里。怎么回事？&lt;/p>
&lt;p>很自然开始怀疑主机有策略，阻止了对xmlrpc的访问。于是把xmlrpc.php随便改个稀奇古怪的名字，再次测试，成功了。&lt;/p></description></item><item><title>MP3 Tag 整理小记</title><link>https://www.palfans.net/how-to-clear-mp3-tag/</link><pubDate>Tue, 21 Aug 2012 13:37:06 +0000</pubDate><guid>https://www.palfans.net/how-to-clear-mp3-tag/</guid><description>&lt;p>很长一段时间，我都是用QQ音乐随便听听，不过现在的版本界面内容越来越多，启动越来越慢，资源越耗越多。于是开始转向foobar2000，似乎是接触得晚了一点，有点儿out。不过随着对foobar2000越来越熟悉，就不自觉的开始有Tag洁癖，尤其是换了几个比较紧凑的CUI之后。再看看自己硬盘上的MP3，Tag乱得一塌糊涂，简直不堪入目，尤其是很多网站还把自己的域名网址在Tag里填得到处都是，一定要想办法清理一下。&lt;/p>
&lt;p>几百首歌，手工处理？我只有疯了才会有这个打算的。人和猴子的区别就是会使用工具。&lt;/p>
&lt;p>首要问题是能自动识别歌曲，并批量修改。TagRename，MP3Tag等都能批量修改，而且带了freedb这个开源数据库进行Tag查询。不过，freedb主要是基于歌曲文件名来识别，而且以专辑为单位识别准确率高，遇到单曲，甚至是从无名网站下载的无名歌曲，基本就无能为力了。于是，我改用Quintessential Media Player(QMP)，它附带了Gracenote这个比较牛逼的数据库的接口。说它牛逼，是因为它可以通过歌曲本身而不是文件名来识别歌曲。把不认识或者Tag不对的歌曲拖到QMP里边，就会自动去Gracenote匹配声音指纹，然后完善Tag。数据库很齐，反正目前为止，我硬盘上所有的歌曲都匹配出来了。本来新版Winamp也带了Gracenote，我也试用了一下，体积太庞大，听个歌，启动一堆面板，还是选QMP，小巧得多。&lt;/p>
&lt;p>不过QMP匹配后的Tag有个问题，就是港台歌手的歌曲，Tag基本上全是繁体中文，而几乎所有的歌词下载工具都不能正确处理繁体中文的歌名或歌手名，导致如果想要自动下载歌词，只能手工把Tag从繁体中文改成简体中文。&lt;/p>
&lt;p>怎么办？我在SB的手工改了几十个文件后，突然想出一个变通的方法，步骤稍多，但省事无数倍。首先，通过TagRename或者MP3Tag读取MP3的Tag信息，把需要处理的MP3的文件名按照歌手-专辑-歌曲名改名。这时文件名都是繁体中文了。然后用ConvertZ这个工具，把这些文件名由繁体中文批量改为简体中文。再通过TagRename或者MP3Tag读取文件名来更新Tag。这样曲线救个国，所有的繁体中文Tag就批量的变为了简体中文。如果你有1000首歌需要处理，我相信，仅需要5分钟，你就能收获极大的快感。&lt;/p>
&lt;p>总结下，整个流程就是 &lt;code>QMP&lt;/code>→&lt;code>TagRename/MP3Tag&lt;/code>→&lt;code>ConvertZ&lt;/code>→&lt;code>TagRename/MP3Tag&lt;/code>，就这么简单。&lt;/p></description></item><item><title>Windows编译OpenVPN客户端（保存密码，修改日志字体）</title><link>https://www.palfans.net/compile-openvpn-gui-n-client/</link><pubDate>Sat, 29 Jan 2011 09:19:49 +0000</pubDate><guid>https://www.palfans.net/compile-openvpn-gui-n-client/</guid><description>&lt;p>OpenVPN客户端一般由两部分组成，OpenVPN和OpenVPN GUI。官方提供的OpenVPN客户端 for Windows为了提高用户账号的安全性，默认不能保存密码。安全性确实提高了，但是遇到网络不好，VPN意外中断时，每次都要手工输入密码，也很烦心。所以我们需要重新编译客户端代码，让其能够保存密码。而OpenVPN GUI的问题在于状态窗口输入的日志字体小得惊人，像我这种戴眼镜后矫正视力才0.6的人，想看清连接状态几乎是不可能的，所以也得改。&lt;/p>
&lt;p>** **&lt;/p>
&lt;p>**&lt;/p>
&lt;p>搭建编译环境**&lt;/p>
&lt;p>我很久没有碰过C语言了，所以除了官方推荐的环境，我不确定其他环境是否能顺利编译。&lt;/p>
&lt;p>NSIS &lt;a href="http://sourceforge.net/projects/nsis/files/NSIS%202/2.46/nsis-2.46-setup.exe/download">下载链接&lt;/a>，建议完全安装。&lt;/p>
&lt;p>MinGW &lt;a href="http://sourceforge.net/projects/mingw/files/Automated%20MinGW%20Installer/">下载链接&lt;/a>，现在MinGW只提供在线安装程序，安装时再下载相关文件，耗时较长。也可以Google一下，有&lt;a href="http://data.99pan.com/download/7621_43_7840485476281515222.html">完整版&lt;/a>可下，假设安装路径为 C:\MinGW&lt;/p>
&lt;p>MSYS &lt;a href="http://downloads.sourceforge.net/mingw/MSYS-1.0.11.exe">下载链接&lt;/a>，假设安装路径为 C:\msys\1.0&lt;/p>
&lt;p>msysDTK &lt;a href="http://downloads.sourceforge.net/mingw/msysDTK-1.0.1.exe">下载链接&lt;/a>，安装路径和MSYS相同，C:\msys\1.0&lt;/p>
&lt;p>配置环境变量，如果变量PATH中已有其他路径，则新增“;C:\MinGW\bin;C:\msys\1.0\bin”，如果变量PATH不存在，则新建一个变量，命名为PATH，内容为“C:\MinGW\bin;C:\msys\1.0\bin”。注意，变量内容都不包含引号，新增变量时，变量内容最前面没有分号。&lt;/p>
&lt;p>配置完成后，打开命令提示符，输入bash，如果界面显示“bash-3.1$”，则编译环境搭建完成。&lt;/p>
&lt;p>** **&lt;/p>
&lt;p>&lt;strong>获取预编译文件&lt;/strong>&lt;/p>
&lt;p>OpenVPN编译过程中需要openssl，tap驱动，lzo压缩等文件，我们可以下载已经编译好的文件 &lt;a href="http://openvpn.net/prebuilt/2.1_rc22-prebuilt.tbz">下载链接&lt;/a>，这里的预编译文件版本不是2.1.1，但不影响实际编译效果。&lt;/p>
&lt;p>新建一个工作目录 C:\work，将预编译文件解压后置于工作目录下，应包含以下四个目录：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">gen-prebuilt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lzo-2.02
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">openssl-0.9.8l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pkcs11-helper
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>编译OpenVPN GUI&lt;/strong>&lt;/p>
&lt;p>获取OpenVPN GUI的源代码 &lt;a href="http://openvpn.se/files/source/openvpn-gui-1.0.3.zip">下载链接&lt;/a>，解压缩到C:\work\openvpn-gui目录下。&lt;/p>
&lt;p>首先修改openvpn.c，找到函数StatusDialogFunc，修改&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">charformat.yHeight = 100;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">strcpy(charformat.szFaceName, &amp;#34;MS Sans Serif&amp;#34;);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>其中100是字体大小，MS Sans Serif是字体名称。&lt;/p>
&lt;p>接下来需要修改Makefile，&lt;/p>
&lt;p>OPENSSL = /c/OpenSSL 改为预编译文件中的openssl下include头文件的位置，这里为&lt;/p>
&lt;p>&lt;code>OPENSSL = ../openssl-0.9.8l/include/openssl&lt;/code>&lt;/p>
&lt;p>LIB_DIRS = -L${OPENSSL}/lib/MinGW 改为预编译文件中openssl的相关lib目录，这里为&lt;/p>
&lt;p>&lt;code>LIB_DIRS = –L../gen-prebuilt/lib&lt;/code>&lt;/p>
&lt;p>运行C:\msys\1.0下的msys.bat，进入类unix环境，切换到C:\work\openvpn-gui目录，执行make，OpenVPN GUI即可编译完成。&lt;/p>
&lt;p>&lt;strong>编译OpenVPN客户端&lt;/strong>&lt;/p>
&lt;p>获取OpenVPN客户端的源代码 &lt;a href="http://openvpn.net/release/openvpn-2.1.1.tar.gz">下载链接&lt;/a>，解压缩到C:\work\openvpn-2.1.1目录下。&lt;/p>
&lt;p>修改misc.c文件，在#ifundef ENABLE_PASSWORD_SAVE一行前面加上&lt;/p>
&lt;p>#define ENABLE_PASSWORD_SAVE&lt;/p>
&lt;p>到install-win32目录，修改openvpn.nsi文件，找到以下代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">; tap-64bit:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DetailPrint “We are running on a 64-bit system.”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SetOutPath “$INSTDIR\bin”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\tapinstall\amd64\tapinstall.exe”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SetOutPath “$INSTDIR\driver”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\driver\amd64\OemWin2k.inf”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\driver\amd64\${PRODUCT_TAP_ID}.cat”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\driver\amd64\${TAPDRV}”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">goto tapend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tap-32bit:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">DetailPrint “We are running on a 32-bit system.”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SetOutPath “$INSTDIR\bin”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\tapinstall\i386\tapinstall.exe”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SetOutPath “$INSTDIR\driver”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\driver\i386\OemWin2k.inf”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\driver\i386\${PRODUCT_TAP_ID}.cat”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">File “${GEN}\driver\i386\${TAPDRV}”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tapend:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SectionEnd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在这段代码最前面插入：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">!undef GEN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!define GEN “C:\work\gen-prebuilt\”
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在这段代码最后面插入：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">undef
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">!define GEN “..”
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打开命令提示符，执行如下命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">cd C:\work\openvpn-2.1.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bash domake-win
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>编译结束后，安装文件会生成在C:\work\openvpn-2.1.1\gen目录下。&lt;/p>
&lt;p>&lt;strong>修改OpenVPN配置文件&lt;/strong>&lt;/p>
&lt;p>修改当前使用的ovpn配置文件，将auth-user-pass改为auth-user-pass pass.txt，同时在相同路径下新增一个名为pass.txt的文本文件，内容为两行，第一行为vpn用户名，第二行为密码。&lt;/p>
&lt;p>重新运行OpenVPN，即可不输密码登录vpn，而且此时status窗口的日志输出，也终于能看得清了。&lt;/p>
&lt;p>顺便提一句，如果有需要vpn的同学，可以和我联系，目前有合租计划，人均每月6元，联系方式如下：&lt;/p>
&lt;p>Twitter: @palfans&lt;/p>
&lt;p>OpenVPN客户端编译部分，参考yegle&lt;a href="https://yegle.net/2010/05/19/compile-openvpn-2-1-1-in-windows/">相关文章&lt;/a>，致谢。&lt;/p></description></item></channel></rss>